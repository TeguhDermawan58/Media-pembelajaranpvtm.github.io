<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Modul: Mekanisme Katup - Moto Edu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        /* --- RESET & DASAR --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #2d2d2d; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* --- LOADER MATRIX --- */
        #loader-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 1s ease-out;
        }
        #matrixCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .loading-text {
            position: relative; z-index: 10000; color: #0F0;
            font-family: 'Courier New', Courier, monospace; font-size: 24px; font-weight: bold;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border: 1px solid #0F0; box-shadow: 0 0 10px #0F0;
            text-align: center;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            height: 50px; background-color: #1a1a1a; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #444; z-index: 300; position: relative;
        }
        .brand { font-weight: bold; color: #ffdb56; display: flex; align-items: center; gap: 15px; }
        .tools { display: flex; gap: 10px; align-items: center; }
        .tool-btn {
            background: transparent; border: none; color: #ccc; cursor: pointer;
            font-size: 18px; padding: 8px; transition: 0.3s; border-radius: 4px;
            text-decoration: none; display: flex; align-items: center;
        }
        .tool-btn:hover { background: #444; color: white; }
        .home-btn { color: #ffdb56; border: 1px solid #ffdb56; font-size: 14px; padding: 5px 15px; font-weight: bold; }
        .home-btn:hover { background: #ffdb56; color: #000; }

        /* --- RESPONSIVE NAVBAR (CSS Saja) --- */
        @media screen and (max-width: 768px) {
            .toolbar { padding: 0 10px; }
            
            /* Judul diperkecil agar muat */
            .brand span { 
                font-size: 13px; 
                max-width: 130px; 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            .brand { gap: 8px; }

            /* Sembunyikan tulisan 'Keluar', sisakan Ikon */
            .home-btn { font-size: 0 !important; padding: 6px 10px !important; }
            .home-btn i { font-size: 14px !important; }

            /* Rapatkan tombol alat */
            .tools { gap: 2px; }
            .tool-btn { font-size: 16px; padding: 6px; }

            /* Loader text responsive */
            .loading-text { font-size: 16px; padding: 5px 10px; }
        }

        /* --- CONTAINER UTAMA --- */
        .main-container {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background: url('https://www.transparenttextures.com/patterns/dark-leather.png'), #252525;
        }

        /* --- SIDEBAR DAFTAR ISI --- */
        .sidebar {
            position: absolute; top: 0; left: 0; bottom: 0; width: 280px;
            background-color: rgba(26, 26, 26, 0.95); border-right: 1px solid #444;
            display: flex; flex-direction: column; z-index: 200;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        @media screen and (max-width: 480px) { .sidebar { width: 100%; } }
        .sidebar.show { transform: translateX(0); }
        .sidebar-header { 
            padding: 15px 20px; color: #ffdb56; border-bottom: 1px solid #444; 
            font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }
        .close-sidebar-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        .toc-list { overflow-y: auto; flex: 1; padding: 10px 0; }
        .toc-item {
            padding: 12px 20px; color: #ccc; cursor: pointer; font-size: 14px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; transition: 0.2s;
        }
        .toc-item:hover { background: #333; color: white; padding-left: 25px; }

        /* --- BUKU / FLIPBOOK (ASLI) --- */
        .book-wrapper {
            position: relative; display: flex; justify-content: center; align-items: center;
            transition: transform 0.3s ease;
        }
        .flip-book { box-shadow: 0 10px 30px rgba(0,0,0,0.6); }

        .page { background-color: white; overflow: hidden; }
        .page-content {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; background-color: #fff;
        }
        canvas.pdf-page-canvas {
            width: 100%; height: 100%; object-fit: contain; display: block;
        }

        /* --- NAVIGASI HOTSPOT & PANAH --- */
        .hotspot-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        .hotspot { 
            position: absolute; cursor: pointer; 
            background: rgba(255, 255, 0, 0); 
            transition: 0.2s;
        }
        .hotspot:hover { background: rgba(255, 219, 86, 0.2); border: 1px dashed rgba(255, 255, 0, 0.5); }

        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; background: rgba(0,0,0,0.5); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 50; border: 2px solid white; transition: 0.3s;
        }
        .nav-arrow:hover { background: #3090d4; transform: translateY(-50%) scale(1.1); }
        .nav-prev { left: 20px; }
        .nav-next { right: 20px; }
        
        /* Panah Navigasi Responsive */
        @media screen and (max-width: 600px) {
            .nav-arrow { width: 35px; height: 35px; opacity: 0.5; }
            .nav-prev { left: 5px; }
            .nav-next { right: 5px; }
        }
    </style>
</head>
<body>
    <div id="loader-container">
        <canvas id="matrixCanvas"></canvas>
        <div class="loading-text" id="loadingText">MEMUAT MODUL KATUP... 0%</div>
    </div>

    <div class="toolbar">
        <div class="brand">
            <button class="tool-btn" id="btnToggleSidebar" title="Daftar Isi"><i class="fas fa-list"></i></button>
            <span>MODUL KATUP & BLOK SILINDER</span>
        </div>
        <div class="tools">
            <a href="../../index.html" class="tool-btn home-btn" title="Kembali ke Website">
                <i class="fas fa-sign-out-alt"></i> &nbsp;Keluar
            </a>
            <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
            <button class="tool-btn" id="btnZoomOut"><i class="fas fa-minus"></i></button>
            <button class="tool-btn" id="btnZoomIn"><i class="fas fa-plus"></i></button>
            <button class="tool-btn" id="btnFullscreen"><i class="fas fa-expand"></i></button>
        </div>
    </div>

    <div class="main-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                DAFTAR ISI
                <button class="close-sidebar-btn" id="btnCloseSidebar"><i class="fas fa-times"></i></button>
            </div>
            <div class="toc-list" id="tocList"></div>
        </aside>

        <div class="nav-arrow nav-prev" id="extPrevBtn"><i class="fas fa-chevron-left"></i></div>
        <div class="nav-arrow nav-next" id="extNextBtn"><i class="fas fa-chevron-right"></i></div>

        <div class="book-wrapper" id="bookWrapper">
            <div id="flipbook" class="flip-book"></div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG FILE PDF ---
        const pdfUrl = 'Katup/katup.pdf'; 

        // --- 2. DAFTAR ISI (Mapping Halaman) ---
        const titles = {
            0: "Cover Depan",
            1: "Daftar Isi",
            2: "Kata Pengantar",
            3: "Petunjuk Penggunaan",
            4: "Peta Konsep",
            5: "Sub Kompetensi",
            6: "Tujuan Pembelajaran",
            7: "Definisi Mekanisme Katup",
            8: "Prinsip Kerja OHC",
            9: "Ciri-Ciri OHC",
            10: "Prinsip DOHC",
            11: "Ciri-Ciri DOHC",
            12: "Kelebihan Dan Kekurangan OHC",
            13: "Kelebihan Dan Kekurangan DOHC",
            14: "Perbandingan DOHC Dan OHC",
            15: "Komponen Katup Dan Camshaft",
            16: "Komponen Pegas Dan Valve",
            17: "Komponen Silinder dan Piston",
            18: "Komponen Pin Piston dan Jalur Pelumasan",
            19: "Perawatan Berkala",
            20: "Perawatan Berkala",
            21: "Diagnosa Perawatan Dan Perbaikan Katup blok silinder",
            22: "Diagnosa Perawatan Dan Perbaikan Katup blok silinder",
            23: "Daftar Pustaka"
        };

        // --- 3. MATRIX BACKGROUND ANIMATION ---
        const canvasMatrix = document.getElementById('matrixCanvas');
        const ctxMatrix = canvasMatrix.getContext('2d');
        canvasMatrix.width = window.innerWidth;
        canvasMatrix.height = window.innerHeight;
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const fontSize = 16;
        const columns = canvasMatrix.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctxMatrix.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctxMatrix.fillRect(0, 0, canvasMatrix.width, canvasMatrix.height);
            ctxMatrix.fillStyle = '#0F0';
            ctxMatrix.font = fontSize + 'px monospace';
            for (let i = 0; i < drops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                ctxMatrix.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvasMatrix.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        const matrixInterval = setInterval(drawMatrix, 30);
        window.addEventListener('resize', () => {
            canvasMatrix.width = window.innerWidth;
            canvasMatrix.height = window.innerHeight;
        });

        // --- 4. LOGIKA LOAD PDF & RENDER FLIPBOOK ---
        document.addEventListener('DOMContentLoaded', async function() {
            const loadingText = document.getElementById('loadingText');
            const loaderContainer = document.getElementById('loader-container');
            const flipbookEl = document.getElementById('flipbook');
            const tocListEl = document.getElementById('tocList');

            try {
                // Konfigurasi PDF.js
                const loadingTask = pdfjsLib.getDocument({
                    url: pdfUrl,
                    disableRange: true,
                    disableStream: true
                });
                
                loadingTask.onProgress = function (progress) {
                    if (progress.total > 0) {
                        const percent = Math.floor((progress.loaded / progress.total) * 100);
                        loadingText.innerText = `MENGUNDUH PDF... ${percent}%`;
                    }
                };

                const pdf = await loadingTask.promise;
                const totalPages = pdf.numPages; // Harus 24 sesuai PDF Anda
                loadingText.innerText = `MERENDER ${totalPages} HALAMAN...`;

                // Loop Render Halaman
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const pageIndex = pageNum - 1; // 0-based index

                    // A. Render Canvas
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 });

                    const pageDiv = document.createElement('div');
                    pageDiv.classList.add('page');
                    // Hard cover effect untuk hal pertama dan terakhir
                    if(pageNum === 1 || pageNum === totalPages) pageDiv.setAttribute('data-density', 'hard');

                    const canvas = document.createElement('canvas');
                    canvas.classList.add('pdf-page-canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = { canvasContext: context, viewport: viewport };
                    await page.render(renderContext).promise;

                    // B. Hotspot & Navigasi
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('page-content');
                    contentDiv.appendChild(canvas);

                    const hotspotLayer = document.createElement('div');
                    hotspotLayer.classList.add('hotspot-layer');
                    let hotspotsHtml = '';

                    // [FITUR 1] Navigasi Umum (Home, Back, Next) di setiap halaman > 1
                    if (pageNum > 1) { 
                        // Home (Ke Cover)
                        hotspotsHtml += `<div class="hotspot" style="top:10%; left:5%; width:15%; height:8%;" onclick="flipToPage(0)" title="Kembali ke Cover"></div>`;
                        // Prev Page
                        hotspotsHtml += `<div class="hotspot" style="top:90%; left:5%; width:15%; height:8%;" onclick="pageFlip.flipPrev()" title="Halaman Sebelumnya"></div>`;
                        // Next Page (kecuali hal terakhir)
                        if (pageNum < totalPages) {
                            hotspotsHtml += `<div class="hotspot" style="top:90%; left:80%; width:15%; height:8%;" onclick="pageFlip.flipNext()" title="Halaman Selanjutnya"></div>`;
                        }
                    }

                    // [FITUR 2] Navigasi Menu Utama di Halaman 2 (Index 1)
                    if (pageNum === 2) {
                        hotspotsHtml += `<div class="hotspot" style="top:30%; left:10%; width:20%; height:15%;" onclick="flipToPage(3)" title="Petunjuk Penggunaan"></div>`;
                        hotspotsHtml += `<div class="hotspot" style="top:30%; left:40%; width:20%; height:15%;" onclick="flipToPage(6)" title="Materi Pembelajaran"></div>`;
                        hotspotsHtml += `<div class="hotspot" style="top:30%; left:70%; width:20%; height:15%;" onclick="toggleSidebar(true)" title="Buka Daftar Isi"></div>`;
                        hotspotsHtml += `<div class="hotspot" style="top:55%; left:10%; width:20%; height:15%;" onclick="flipToPage(5)" title="Tujuan Pembelajaran"></div>`;
                        hotspotsHtml += `<div class="hotspot" style="top:55%; left:40%; width:20%; height:15%;" onclick="flipToPage(4)" title="Peta Konsep"></div>`;
                        hotspotsHtml += `<div class="hotspot" style="top:55%; left:70%; width:20%; height:15%;" onclick="flipToPage(23)" title="Daftar Pustaka"></div>`;
                    }

                    hotspotLayer.innerHTML = hotspotsHtml;
                    contentDiv.appendChild(hotspotLayer);
                    pageDiv.appendChild(contentDiv);
                    flipbookEl.appendChild(pageDiv);

                    // C. Isi Sidebar Daftar Isi
                    let titleText = titles[pageIndex] ? titles[pageIndex] : `Halaman ${pageNum}`;
                    const tocItem = document.createElement('div');
                    tocItem.className = 'toc-item';
                    tocItem.innerHTML = `<span>${titleText}</span> <span style="font-size:11px; opacity:0.5">${pageNum}</span>`;
                    tocItem.onclick = () => { window.flipToPage(pageIndex); toggleSidebar(false); };
                    tocListEl.appendChild(tocItem);

                    const renderPercent = Math.floor((pageNum / totalPages) * 100);
                    loadingText.innerText = `MENYIAPKAN BUKU... ${renderPercent}%`;
                }

                setTimeout(() => {
                    clearInterval(matrixInterval);
                    loaderContainer.style.opacity = '0';
                    setTimeout(() => { loaderContainer.style.display = 'none'; }, 1000);
                }, 500);

                // --- 5. INISIALISASI FLIPBOOK (ASLI - TANPA UBAHAN LOGIKA MOBILE) ---
                // Konfigurasi ini sama persis dengan yang ada di modul pendingin
                const pageFlip = new St.PageFlip(flipbookEl, {
                    width: 450, height: 637,
                    size: "stretch", minWidth: 300, maxWidth: 1000,
                    minHeight: 400, maxHeight: 1200,
                    maxShadowOpacity: 0.5, showCover: true, mobileScrollSupport: false
                });

                pageFlip.loadFromHTML(document.querySelectorAll('.page'));

                window.pageFlip = pageFlip;
                window.flipToPage = (idx) => {
                    if(idx >= 0 && idx < totalPages) pageFlip.flip(idx);
                };

                document.getElementById('extPrevBtn').onclick = () => pageFlip.flipPrev();
                document.getElementById('extNextBtn').onclick = () => pageFlip.flipNext();
                document.addEventListener('keydown', (e) => {
                    if (e.key === "ArrowRight") pageFlip.flipNext();
                    if (e.key === "ArrowLeft") pageFlip.flipPrev();
                });

            } catch (error) {
                console.error("Error:", error);
                loadingText.innerText = "GAGAL MEMUAT PDF! File 'Katup/katup.pdf' tidak ditemukan.";
                loadingText.style.color = "red";
            }
        });

        // --- 6. UI CONTROLS ---
        const sidebar = document.getElementById('sidebar');
        function toggleSidebar(show) {
            if (show) sidebar.classList.add('show'); else sidebar.classList.remove('show');
        }
        document.getElementById('btnToggleSidebar').onclick = () => toggleSidebar(!sidebar.classList.contains('show'));
        document.getElementById('btnCloseSidebar').onclick = () => toggleSidebar(false);

        let currentZoom = 1;
        const bookDiv = document.getElementById('flipbook');
        document.getElementById('btnZoomIn').onclick = () => {
            if (currentZoom < 1.5) { currentZoom += 0.1; bookDiv.style.transform = `scale(${currentZoom})`; }
        };
        document.getElementById('btnZoomOut').onclick = () => {
            if (currentZoom > 0.6) { currentZoom -= 0.1; bookDiv.style.transform = `scale(${currentZoom})`; }
        };
        document.getElementById('btnFullscreen').onclick = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        };
    </script>
</body>
</html>